<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sync & Savor</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-teal': '#14b8a6', // Tailwind teal-500
                        'primary-dark': '#0f766e', // Tailwind teal-700
                        'primary-light': '#ccfbf1', // Tailwind teal-100
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            background-color: #f7f9fc;
            color: #1f2937;
            padding-bottom: 5rem; /* Space for fixed nav */
        }
        .container-app {
            max-width: 900px;
            margin: 0 auto;
            padding: 1rem;
        }
        .nav-tab-bottom {
            transition: color 0.2s;
            flex-grow: 1;
        }
        .dashed-box {
            border: 2px dashed #d1d5db;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .dashed-box:hover {
            border-color: #38bdf8; /* Blue accent on hover */
        }
        .active-meal-slot {
            background-color: #ccfbf1; /* primary-light */
            border: 2px solid #14b8a6; /* primary-teal */
            color: #065f46; /* green-900 */
        }
        /* Style adjustments for image grid to match design */
        .recipe-action-grid button {
            background-color: #ccfbf1;
            color: #0f766e;
            border: 1px solid #14b8a6;
            transition: all 0.2s;
        }
        .recipe-action-grid button:hover {
            background-color: #99f6e4;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .modal-active .modal-overlay {
            opacity: 1;
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 1.5rem;
            max-width: 95%;
            width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            transform: translateY(20px);
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            opacity: 0;
        }
        /* Top section styling based on image */
        .top-header {
            background-color: #14b8a6;
            color: white;
            padding: 1rem;
            padding-bottom: 2rem;
            border-bottom-left-radius: 2rem;
            border-bottom-right-radius: 2rem;
        }
    </style>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body class="min-h-screen">
    
    <!-- Top Header (Inspired by image) -->
    <div id="top-header" class="top-header sticky top-0 z-10 shadow-lg">
        <div class="container-app p-0 flex justify-between items-center">
            <h1 class="text-2xl font-bold flex items-center">
                <i data-lucide="book-open-text" class="w-6 h-6 mr-2"></i>
                Sync & Savor
            </h1>
            <div class="flex space-x-3">
                <i data-lucide="search" class="w-6 h-6 cursor-pointer"></i>
                <i data-lucide="user" class="w-6 h-6 cursor-pointer"></i>
            </div>
        </div>
    </div>
    
    <div class="container-app py-6">
        
        <!-- User ID Display (MANDATORY for multi-user apps) -->
        <div id="user-id-display" class="hidden mt-2 mb-6 bg-gray-100 p-2 rounded-lg text-xs font-mono break-words shadow-inner">
            <span class="font-bold text-gray-700"></span>
        </div>

        <!-- --- RECIPES VIEW --- -->
        <main id="recipes-view" class="view">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Add New Recipe</h2>
            
            <!-- 4-Option Grid (Matching unnamed.png) -->
            <div class="grid grid-cols-2 gap-4 mb-8 recipe-action-grid">
                <!-- Take Photo (Placeholder for real device camera) -->
                <button onclick="document.getElementById('file-input-ocr').click()" class="flex flex-col items-center justify-center p-4 h-28 rounded-xl shadow-md">
                    <i data-lucide="camera" class="w-6 h-6 mb-2"></i>
                    <span class="font-semibold">Take Photo</span>
                </button>
                <!-- Upload Photo (OCR functionality) -->
                <button onclick="document.getElementById('file-input-ocr').click()" class="flex flex-col items-center justify-center p-4 h-28 rounded-xl shadow-md">
                    <i data-lucide="upload" class="w-6 h-6 mb-2"></i>
                    <span class="font-semibold">Upload Photo</span>
                    <input type="file" id="file-input-ocr" accept="image/*" class="hidden" onchange="handleOCRUpload(event)">
                </button>
                <!-- Search Web (Placeholder) -->
                <button class="flex flex-col items-center justify-center p-4 h-28 rounded-xl shadow-md opacity-50 cursor-not-allowed">
                    <i data-lucide="globe" class="w-6 h-6 mb-2"></i>
                    <span class="font-semibold">Search Web</span>
                </button>
                <!-- Import URL (LLM Grounding) -->
                <button onclick="openModal('import-url-modal')" class="flex flex-col items-center justify-center p-4 h-28 rounded-xl shadow-md">
                    <i data-lucide="link" class="w-6 h-6 mb-2"></i>
                    <span class="font-semibold">Import URL</span>
                </button>
            </div>

            <h2 class="text-xl font-bold mb-4 flex justify-between items-center">
                Recent Recipes
                <!-- <button class="text-sm text-primary-teal font-medium">View All</button> -->
            </h2>
            
            <p id="recipe-list-status" class="text-center text-gray-500 italic py-8" style="display:none;">
                Loading recipes...
            </p>

            <div id="recent-recipes-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Recipe cards will be injected here by JS -->
            </div>

            <!-- Recipe Card Template (Hidden) -->
            <template id="recipe-card-template">
                <div class="bg-white p-5 rounded-xl shadow-md border border-gray-200 hover:shadow-lg transition cursor-pointer">
                    <h3 data-name class="text-xl font-bold text-gray-800 line-clamp-1 mb-2">Recipe Name</h3>
                    <p data-description class="text-sm text-gray-600 line-clamp-2 mb-3">A short description of the recipe.</p>
                    <div class="flex justify-between items-center text-sm mt-3">
                        <span class="bg-primary-light text-primary-dark font-medium px-3 py-1 rounded-full flex items-center gap-1">
                            <i data-lucide="clock" class="w-4 h-4"></i><span data-time>45 min</span>
                        </span>
                        <span class="text-gray-500 font-medium" data-difficulty>Medium</span>
                        <span class="bg-gray-100 text-gray-500 font-medium px-3 py-1 rounded-full text-xs" data-tags>Source</span>
                    </div>
                </div>
            </template>
        </main>

        <!-- --- MEAL PLAN VIEW --- -->
        <main id="plan-view" class="view" style="display: none;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Weekly Meal Plan</h2>
                <div class="flex items-center text-gray-800 font-semibold">
                    <i data-lucide="chevron-left" class="w-6 h-6 cursor-pointer opacity-50"></i>
                    <span id="current-week-display" class="mx-3 text-lg text-primary-dark">Loading...</span>
                    <i data-lucide="chevron-right" class="w-6 h-6 cursor-pointer opacity-50"></i>
                </div>
            </div>

            <div id="weekly-plan-container">
                <!-- Day cards will be injected here by JS -->
            </div>
        </main>

        <!-- --- SHOPPING VIEW --- -->
        <main id="shopping-view" class="view" style="display: none;">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Shopping List</h2>
            <div id="shopping-list-content" class="bg-white p-6 rounded-xl shadow-md border border-gray-100 min-h-64 flex flex-col items-center justify-center text-center">
                <i data-lucide="shopping-cart" class="w-16 h-16 text-gray-300 mb-4"></i>
                <p class="text-lg font-semibold text-gray-700">Your shopping list is empty.</p>
                <p class="text-sm text-gray-500 mt-1">Generate one from your current meal plans!</p>
                <button onclick="generateShoppingList()" class="mt-4 bg-primary-teal hover:bg-primary-dark text-white font-semibold py-2 px-4 rounded-xl transition shadow-md">
                    Generate List
                </button>
            </div>
            
            <!-- List will be rendered here upon generation -->
            <div id="generated-shopping-list" class="mt-6 space-y-4"></div>
        </main>
        
        <!-- --- DISCOVER VIEW --- -->
        <main id="discover-view" class="view" style="display: none;">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Discover New Recipes</h2>
            <div class="bg-white p-6 rounded-xl shadow-md border border-gray-100 min-h-64 flex flex-col items-center justify-center text-center">
                <i data-lucide="compass" class="w-16 h-16 text-gray-300 mb-4"></i>
                <p class="text-lg font-semibold text-gray-700">Coming Soon</p>
                <p class="text-sm text-gray-500 mt-1">Explore and save new recipes here.</p>
            </div>
        </main>
    </div>

    <!-- --- MODALS --- -->

    <!-- 1. Import URL Modal (LLM Grounding) -->
    <div id="import-url-modal" class="modal-overlay" onclick="if(event.target === this) closeModal('import-url-modal')">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-4 text-gray-800">Import Recipe from URL</h3>
            <form id="import-url-form" class="space-y-4">
                <p class="text-sm text-gray-600">Paste the URL of any online recipe. AI will extract the details.</p>
                <input type="url" id="recipe-url" placeholder="https://example.com/best-chicken-recipe" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-teal focus:border-primary-teal">
                
                <p id="import-url-status-message" class="text-sm text-red-500 hidden"></p>

                <div class="flex justify-end pt-2">
                    <button id="import-recipe-btn" type="submit" class="bg-primary-teal hover:bg-primary-dark text-white font-semibold py-2 px-4 rounded-xl transition shadow-md flex items-center justify-center min-w-[150px]">
                        <span id="import-url-spinner" class="hidden h-5 w-5 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></span>
                        Import Recipe
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 2. OCR Status Modal (For Photo Upload) -->
    <div id="ocr-status-modal" class="modal-overlay">
        <div class="modal-content flex flex-col items-center text-center">
            <h3 class="text-2xl font-bold mb-4 text-gray-800" id="ocr-modal-title">Processing Photo...</h3>
            <div id="ocr-spinner" class="h-10 w-10 border-4 border-primary-teal border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="text-gray-600" id="ocr-modal-message">Analyzing image to extract recipe data. This may take a moment...</p>
            <p class="text-xs text-red-500 mt-4 hidden" id="ocr-error-message"></p>
            <button onclick="closeModal('ocr-status-modal')" id="ocr-close-btn" class="hidden mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-xl transition">
                Close
            </button>
        </div>
    </div>

    <!-- 3. Recipe Detail Modal (Viewer) -->
    <div id="recipe-detail-modal" class="modal-overlay" onclick="if(event.target === this) closeModal('recipe-detail-modal')">
        <div class="modal-content w-[600px] max-h-[90vh] overflow-y-auto">
            <h3 id="detail-name" class="text-3xl font-extrabold mb-2 text-primary-teal">Recipe Name</h3>
            <p id="detail-description" class="text-gray-600 mb-4 text-sm"></p>

            <div class="flex justify-between items-center text-sm mb-6 p-3 bg-gray-100 rounded-lg">
                <span class="text-gray-600 font-semibold">Time: <span data-detail="time" class="text-gray-800 font-bold">N/A</span></span>
                <span class="text-gray-600 font-semibold">Difficulty: <span data-detail="difficulty" class="text-gray-800 font-bold">N/A</span></span>
            </div>

            <div class="mb-6">
                <h4 class="text-xl font-bold mb-3 border-b pb-1">Ingredients</h4>
                <ul id="detail-ingredients" class="list-disc pl-5 space-y-1 text-gray-700 text-base">
                    <!-- Ingredients injected here -->
                </ul>
            </div>

            <div>
                <h4 class="text-xl font-bold mb-3 border-b pb-1">Instructions</h4>
                <ol id="detail-instructions" class="list-decimal pl-5 space-y-2 text-gray-700 text-base">
                    <!-- Instructions injected here -->
                </ol>
            </div>
            
            <div class="flex justify-end pt-4">
                <button type="button" onclick="closeModal('recipe-detail-modal')" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-xl transition">
                    Close
                </button>
            </div>
        </div>
    </div>
    
    <!-- 4. Select Recipe Modal (Meal Planning) -->
    <div id="select-recipe-modal" class="modal-overlay" onclick="if(event.target === this) closeModal('select-recipe-modal')">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-2 text-gray-800">Assign Meal Slot</h3>
            <p id="slot-context" class="text-gray-600 mb-4">Assign a recipe to your meal slot:</p>

            <div class="max-h-80 overflow-y-auto space-y-3 p-1" id="recipe-selection-list">
                <!-- Recipe selection list injected here -->
            </div>
            
            <div class="flex justify-between items-center pt-4">
                <button id="remove-meal-btn" onclick="removeMealAssignment()" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-xl transition shadow-md">
                    Remove Meal
                </button>
                <button type="button" onclick="closeModal('select-recipe-modal')" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-xl transition">
                    Done
                </button>
            </div>
        </div>
    </div>


    <!-- --- Bottom Navigation Bar (Fixed) --- -->
    <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-xl z-20">
        <div class="max-w-xl mx-auto flex justify-around items-center h-16">
            <button class="nav-tab-bottom flex flex-col items-center justify-center p-2" data-view="recipes" onclick="showView('recipes', event)">
                <i data-lucide="book-open-text" class="w-6 h-6"></i>
                <span class="text-xs font-medium mt-1">Recipes</span>
            </button>
            <button class="nav-tab-bottom flex flex-col items-center justify-center p-2" data-view="plan" onclick="showView('plan', event)">
                <i data-lucide="calendar-check" class="w-6 h-6"></i>
                <span class="text-xs font-medium mt-1">Plan</span>
            </button>
            <button class="nav-tab-bottom flex flex-col items-center justify-center p-2" data-view="shopping" onclick="showView('shopping', event)">
                <i data-lucide="shopping-cart" class="w-6 h-6"></i>
                <span class="text-xs font-medium mt-1">Shopping</span>
            </button>
            <button class="nav-tab-bottom flex flex-col items-center justify-center p-2" data-view="discover" onclick="showView('discover', event)">
                <i data-lucide="compass" class="w-6 h-6"></i>
                <span class="text-xs font-medium mt-1">Discover</span>
            </button>
        </div>
    </nav>


    <!-- --- JavaScript & Firebase Logic --- -->
    <script type="module">
        // Firebase Imports (CDN)
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, deleteField, collection, query, onSnapshot, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global State ---
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let currentView = 'recipes';
        let allRecipes = {}; // Store recipes by ID: { [recipeId]: { ...recipeData } }
        let currentPlan = {}; // Store current week's plan: { [day]: { [meal]: { recipeId: '...' } } }
        let currentWeekId = getWeekId(new Date()); // e.g., '2025-W39'
        let currentSelectedSlot = { day: null, meal: null, recipeId: null }; // For Meal Planning Modal
        let shoppingListIngredients = []; // Array of ingredient strings for shopping list view

        // Global variables are provided by the canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseConfig = {};
        try {
            firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        } catch (e) {
            console.error("Firebase Config Parsing Error:", e);
        }

        const MAX_RETRIES = 3;

        // --- Date & Week Helpers ---

        function getWeekId(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return `${d.getUTCFullYear()}-W${weekNo}`;
        }

        function getWeekDisplay(weekId) {
            const now = new Date();
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - (now.getDay() === 0 ? 6 : now.getDay() - 1));
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);

            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            
            const startMonth = monthNames[startOfWeek.getMonth()];
            const startDate = startOfWeek.getDate();
            const endMonth = monthNames[endOfWeek.getMonth()];
            const endDate = endOfWeek.getDate();

            if (startOfWeek.getMonth() === endOfWeek.getMonth()) {
                return `${startMonth} ${startDate} - ${endDate}`;
            } else {
                return `${startMonth} ${startDate} - ${endMonth} ${endDate}`;
            }
        }

        // --- Firebase Core ---

        async function initializeFirebase() {
            setLogLevel('Debug');
            
            if (!firebaseConfig.apiKey) {
                console.error("Firebase: Configuration is missing API key. Data will not persist.");
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        if (token) {
                            await signInWithCustomToken(auth, token);
                            userId = auth.currentUser.uid;
                        } else {
                            await signInAnonymously(auth);
                            userId = auth.currentUser.uid;
                        }
                    }
                    
                    isAuthReady = true;
                    console.log("User authenticated:", userId);
                    updateUserInfo(userId);
                    setupFirestoreListeners();
                });

            } catch (error) {
                console.error("Firebase Initialization or Auth Error:", error);
            }
        }

        function updateUserInfo(id) {
            const display = document.getElementById('user-id-display');
            if (display) {
                const span = display.querySelector('span');
                span.textContent = id;
                display.classList.remove('hidden');
            }
        }

        function setupFirestoreListeners() {
            if (!db || !userId || !isAuthReady) return;
            
            setupRecipeListener();
            setupMealPlanListener();
        }

        // --- Recipe Logic & Schema ---

        const RECIPE_SCHEMA = {
            type: "OBJECT",
            properties: {
                "name": { "type": "STRING", "description": "The full title of the recipe." },
                "description": { "type": "STRING", "description": "A brief one or two sentence summary of the recipe." },
                "time": { "type": "STRING", "description": "The estimated total preparation and cook time, e.g., '45 min'." },
                "difficulty": { "type": "STRING", "enum": ["Easy", "Medium", "Hard"], "description": "Difficulty level based on complexity." },
                "ingredients": {
                    "type": "ARRAY",
                    "items": { "type": "STRING", "description": "Each item is a single line, e.g., '1 cup all-purpose flour'." }
                },
                "instructions": {
                    "type": "ARRAY",
                    "items": { "type": "STRING", "description": "Each item is a single, concise step of the instructions." }
                }
            },
            required: ["name", "ingredients", "instructions"],
            propertyOrdering: ["name", "description", "time", "difficulty", "ingredients", "instructions"]
        };

        async function saveRecipeToFirestore(recipeData) {
            if (!db || !userId) {
                console.error("Database or User ID is not ready.");
                return false;
            }
            try {
                const newRecipeDoc = {
                    ...recipeData,
                    createdAt: new Date().toISOString()
                };
                
                const userRecipesPath = `artifacts/${appId}/users/${userId}/recipes`;
                const docRef = await addDoc(collection(db, userRecipesPath), newRecipeDoc);
                console.log("Recipe added with ID: ", docRef.id);
                return true;
            } catch (e) {
                console.error("Critical error saving recipe: ", e);
                return false;
            }
        }

        function setupRecipeListener() {
            const userRecipesPath = `artifacts/${appId}/users/${userId}/recipes`;
            const recipesQuery = query(collection(db, userRecipesPath));
            const container = document.getElementById('recent-recipes-list');
            const status = document.getElementById('recipe-list-status');

            onSnapshot(recipesQuery, (snapshot) => {
                if (!isAuthReady) return;

                allRecipes = {};
                container.innerHTML = '';
                
                if (snapshot.empty) {
                    status.textContent = 'No recipes yet. Add your first recipe!';
                    status.style.display = 'block';
                } else {
                    status.style.display = 'none';
                    const fragment = document.createDocumentFragment();
                    
                    snapshot.forEach(doc => {
                        const recipe = doc.data();
                        recipe.id = doc.id;
                        allRecipes[recipe.id] = recipe;
                        
                        const cardElement = document.createElement('div');
                        cardElement.innerHTML = document.getElementById('recipe-card-template').innerHTML;
                        const card = cardElement.firstElementChild;
                        
                        card.querySelector('[data-name]').textContent = recipe.name || 'Untitled Recipe';
                        card.querySelector('[data-description]').textContent = recipe.description || 'No description provided.';
                        card.querySelector('[data-time]').textContent = recipe.time || 'N/A';
                        card.querySelector('[data-difficulty]').textContent = recipe.difficulty || 'Easy';
                        card.querySelector('[data-tags]').textContent = recipe.source || 'User Added';
                        
                        card.setAttribute('data-doc-id', recipe.id);
                        card.setAttribute('data-recipe-json', JSON.stringify(recipe));
                        card.onclick = () => openRecipeDetail(card);

                        fragment.appendChild(card);
                    });
                    
                    container.appendChild(fragment);
                    lucide.createIcons(); // Re-render icons after injection
                }
                
                // Re-render the Plan view and Selection list
                renderWeeklyPlan(currentPlan);
                if(document.getElementById('select-recipe-modal').style.display === 'flex') {
                    updateRecipeSelectorList();
                }

            }, (error) => {
                console.error("Error listening to recipes:", error);
                status.textContent = 'Error loading recipes. Check console.';
                status.style.display = 'block';
            });
        }

        // --- LLM URL Import Logic ---

        async function importRecipeFromUrl(e) {
            e.preventDefault();

            const url = document.getElementById('recipe-url').value;
            if (!url) return;
            
            const importBtn = document.getElementById('import-recipe-btn');
            const spinner = document.getElementById('import-url-spinner');
            const form = document.getElementById('import-url-form');
            const statusMessage = document.getElementById('import-url-status-message');
            
            // Set Loading State
            importBtn.disabled = true;
            importBtn.innerHTML = '<span id="import-url-spinner" class="h-5 w-5 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></span> Importing...';
            statusMessage.classList.add('hidden');
            
            // Use empty string for apiKey so the Canvas runtime can inject the credentials
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const systemPrompt = "You are an expert recipe extractor. Given a URL, your task is to accurately extract the recipe's name, description, time, difficulty, ingredients, and instructions. The output MUST strictly adhere to the provided JSON schema. If any field (except name, ingredients, instructions) is not found, omit it or use an empty string/default value like 'N/A' or 'Easy'.";
            const userQuery = `Find the recipe on this webpage: ${url}. Extract the details into the requested JSON format.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: RECIPE_SCHEMA
                }
            };
            
            let recipeData = null;
            let attempt = 0;

            while (attempt < MAX_RETRIES) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        // Log 401 specifically for user awareness, but continue retry logic
                        if (response.status === 401) {
                            console.error(`Attempt ${attempt + 1} failed: Error: API returned status 401. Please check if your Gemini API key is valid if you are using one.`);
                        }
                        throw new Error(`API returned status ${response.status}`);
                    }

                    const result = await response.json();
                    const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (jsonText) {
                        recipeData = JSON.parse(jsonText);
                        recipeData.source = `Imported from ${new URL(url).hostname}`;
                        break;
                    }
                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error);
                    attempt++;
                    if (attempt < MAX_RETRIES) await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                }
            }
            
            // Restore button state
            importBtn.disabled = false;
            importBtn.innerHTML = 'Import Recipe';

            if (recipeData && recipeData.name && recipeData.ingredients.length > 0) {
                const saved = await saveRecipeToFirestore(recipeData);
                if (saved) {
                    form.reset();
                    closeModal('import-url-modal');
                    showView('recipes');
                    return;
                }
            }

            statusMessage.textContent = 'Error: Could not extract a valid recipe. Please check the URL.';
            statusMessage.classList.remove('hidden');
        }


        // --- LLM Image OCR/Upload Logic ---

        /**
         * Converts a File object to a Base64 string.
         * @param {File} file - The file to convert.
         * @returns {Promise<string>} Base64 data part only.
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        /**
         * Handles the file input change event for OCR.
         */
        async function handleOCRUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            openModal('ocr-status-modal');
            const modalTitle = document.getElementById('ocr-modal-title');
            const modalMessage = document.getElementById('ocr-modal-message');
            const spinner = document.getElementById('ocr-spinner');
            const errorMsg = document.getElementById('ocr-error-message');
            const closeBtn = document.getElementById('ocr-close-btn');
            
            // Reset modal state
            modalTitle.textContent = "Processing Photo...";
            modalMessage.textContent = "Analyzing image to extract recipe data. This may take a moment...";
            spinner.classList.remove('hidden');
            errorMsg.classList.add('hidden');
            closeBtn.classList.add('hidden');

            try {
                const base64ImageData = await fileToBase64(file);
                const mimeType = file.type;
                
                // Call the extraction function
                const recipeData = await extractRecipeFromImage(base64ImageData, mimeType);

                if (recipeData && recipeData.name && recipeData.ingredients.length > 0) {
                    recipeData.source = 'OCR Upload';
                    const saved = await saveRecipeToFirestore(recipeData);
                    
                    if (saved) {
                        modalTitle.textContent = "Success!";
                        modalMessage.textContent = `Successfully extracted and saved: ${recipeData.name}.`;
                        spinner.classList.add('hidden');
                        closeBtn.classList.remove('hidden');
                        document.getElementById('file-input-ocr').value = ''; // Clear file input
                        showView('recipes');
                    } else {
                        throw new Error("Failed to save extracted recipe to database.");
                    }
                } else {
                    throw new Error("AI could not extract a complete recipe from the image. Please try a clearer photo.");
                }

            } catch (error) {
                console.error("OCR Process Error:", error);
                modalTitle.textContent = "Extraction Failed";
                modalMessage.textContent = "An error occurred during processing.";
                errorMsg.textContent = error.message.includes("AI could not extract") ? error.message : "Please check the image quality and console for details.";
                errorMsg.classList.remove('hidden');
                spinner.classList.add('hidden');
                closeBtn.classList.remove('hidden');
            }
        }

        /**
         * Calls Gemini API for image understanding.
         */
        async function extractRecipeFromImage(base64ImageData, mimeType) {
            // Use empty string for apiKey so the Canvas runtime can inject the credentials
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const systemPrompt = "You are an expert at optical character recognition (OCR) and text structuring. Analyze the image to find a recipe. Extract the recipe's name, description, time, difficulty, ingredients (each on a separate line), and instructions (each step on a separate line). The output MUST strictly adhere to the provided JSON schema. If any field is not found, use a sensible default or an empty array.";
            
            const payload = {
                contents: [
                    {
                        role: "user",
                        parts: [
                            { text: "Extract the full recipe from this image. Structure the output as requested JSON." },
                            {
                                inlineData: {
                                    mimeType: mimeType,
                                    data: base64ImageData
                                }
                            }
                        ]
                    }
                ],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: RECIPE_SCHEMA
                }
            };
            
            let recipeData = null;
            let attempt = 0;

            while (attempt < MAX_RETRIES) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        // Log 401 specifically for user awareness, but continue retry logic
                         if (response.status === 401) {
                            console.error(`OCR API Attempt ${attempt + 1} failed: Error: API returned status 401. Please check if your Gemini API key is valid if you are using one.`);
                        }
                        throw new Error(`API returned status ${response.status}`);
                    }


                    const result = await response.json();
                    const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (jsonText) {
                        recipeData = JSON.parse(jsonText);
                        break;
                    }
                } catch (error) {
                    console.error(`OCR API Attempt ${attempt + 1} failed:`, error);
                    attempt++;
                    if (attempt < MAX_RETRIES) await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                }
            }
            return recipeData;
        }

        // --- Shopping List Logic ---
        
        /**
         * Generates and renders the shopping list from the current meal plan.
         */
        function generateShoppingList() {
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            shoppingListIngredients = []; // Reset list
            const ingredientMap = {};
            
            // 1. Collect all ingredients from the planned recipes
            days.forEach(day => {
                const dayPlan = currentPlan[day] || {};
                const meals = ['Breakfast', 'Lunch', 'Dinner'];
                
                meals.forEach(meal => {
                    const recipeId = dayPlan[meal]?.recipeId;
                    const recipe = allRecipes[recipeId];
                    
                    if (recipe && Array.isArray(recipe.ingredients)) {
                        recipe.ingredients.forEach(item => {
                            // Simple deduplication based on item string
                            ingredientMap[item.toLowerCase()] = item;
                        });
                    }
                });
            });
            
            shoppingListIngredients = Object.values(ingredientMap).sort((a, b) => a.localeCompare(b));

            // 2. Render the list
            const listContainer = document.getElementById('generated-shopping-list');
            const emptyContainer = document.getElementById('shopping-list-content');
            listContainer.innerHTML = '';
            
            if (shoppingListIngredients.length === 0) {
                listContainer.style.display = 'none';
                emptyContainer.style.display = 'flex';
                // Add a specific message if recipes exist but plan is empty
                if (Object.keys(allRecipes).length > 0) {
                     emptyContainer.querySelector('p:nth-child(2)').textContent = 'Generate one from your current meal plans!';
                } else {
                     emptyContainer.querySelector('p:nth-child(2)').textContent = 'Add recipes and plan meals first!';
                }
                return;
            }
            
            emptyContainer.style.display = 'none';
            listContainer.style.display = 'block';

            const ul = document.createElement('ul');
            ul.className = 'bg-white rounded-xl shadow-md divide-y divide-gray-100 border border-gray-200';

            shoppingListIngredients.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = 'p-4 flex justify-between items-center transition hover:bg-gray-50 cursor-pointer';
                li.innerHTML = `
                    <label class="flex items-center space-x-3 w-full">
                        <input type="checkbox" class="h-5 w-5 text-primary-teal rounded border-gray-300 focus:ring-primary-teal">
                        <span class="text-lg text-gray-800">${item}</span>
                    </label>
                `;
                ul.appendChild(li);
            });

            listContainer.appendChild(ul);
        }

        // --- Meal Plan Logic (Retained from previous version) ---
        
        function setupMealPlanListener() {
            const planDocPath = `artifacts/${appId}/users/${userId}/meal_plans/${currentWeekId}`;
            const planRef = doc(db, planDocPath);
            
            document.getElementById('current-week-display').textContent = getWeekDisplay(currentWeekId);

            onSnapshot(planRef, (docSnapshot) => {
                if (!isAuthReady) return;

                currentPlan = docSnapshot.exists() ? docSnapshot.data() : {};
                renderWeeklyPlan(currentPlan);
                generateShoppingList(); // Re-generate list on plan change
            }, (error) => {
                console.error("Error listening to meal plan:", error);
            });
        }

        function renderWeeklyPlan(planData) {
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const planContainer = document.getElementById('weekly-plan-container');
            planContainer.innerHTML = '';

            const fragment = document.createDocumentFragment();
            
            // Render day cards
            days.forEach(day => {
                const dayPlan = planData[day] || {};
                const dayCardHtml = generateDayCardHtml(day, dayPlan);
                
                const div = document.createElement('div');
                div.innerHTML = dayCardHtml;
                fragment.appendChild(div.firstElementChild);
            });

            planContainer.appendChild(fragment);
            lucide.createIcons(); // Re-render icons
        }

        function generateDayCardHtml(dayName, dayPlan) {
            const meals = ['Breakfast', 'Lunch', 'Dinner'];
            return `
                <div class="bg-white p-4 rounded-xl shadow-lg mb-4 border border-gray-100">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">${dayName}</h3>
                    <div class="grid grid-cols-3 gap-3">
                        ${meals.map(mealName => {
                            const assignment = dayPlan[mealName];
                            const assignedRecipe = assignment && assignment.recipeId ? allRecipes[assignment.recipeId] : null;

                            let recipeName = '+';
                            let classNames = 'dashed-box text-gray-400 border-gray-300 hover:border-blue-400';
                            let recipeId = 'none';

                            if (assignedRecipe) {
                                recipeName = assignedRecipe.name;
                                classNames = 'active-meal-slot text-green-900 border-primary-teal shadow-inner';
                                recipeId = assignedRecipe.id;
                            }
                            
                            return `
                                <div class="flex flex-col items-center justify-center h-28 rounded-xl p-2 transition ${classNames}"
                                    data-day="${dayName}" data-meal="${mealName}" data-recipe-id="${recipeId}"
                                    onclick="handleSlotClick(this)">
                                    <span class="text-xs font-semibold uppercase text-gray-500">${mealName}</span>
                                    <p class="text-sm font-medium mt-1 text-center line-clamp-2 ${assignedRecipe ? 'text-primary-dark' : 'text-gray-400'}">
                                        ${assignedRecipe ? recipeName : '+'}
                                    </p>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }
        
        function handleSlotClick(slot) {
            if (Object.keys(allRecipes).length === 0) return;

            const day = slot.getAttribute('data-day');
            const meal = slot.getAttribute('data-meal');
            const recipeId = slot.getAttribute('data-recipe-id');

            currentSelectedSlot = { day, meal, recipeId };
            
            document.getElementById('slot-context').textContent = `Assign a recipe to your ${meal} on ${day}:`;
            
            const removeBtn = document.getElementById('remove-meal-btn');
            removeBtn.style.display = (recipeId && recipeId !== 'none') ? 'block' : 'none';

            openModal('select-recipe-modal');
        }

        function updateRecipeSelectorList() {
            const listContainer = document.getElementById('recipe-selection-list');
            listContainer.innerHTML = '';
            
            const recipes = Object.values(allRecipes).sort((a, b) => a.name.localeCompare(b.name)); 

            if (recipes.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-gray-500 italic py-4">No recipes available to select. Add one first!</p>';
                return;
            }
            
            recipes.forEach(recipe => {
                const isSelected = currentSelectedSlot.recipeId === recipe.id;
                
                const listItem = document.createElement('div');
                listItem.className = `p-3 rounded-xl border transition cursor-pointer flex items-center justify-between shadow-sm ${isSelected ? 'border-primary-teal bg-teal-50 font-bold' : 'border-gray-200 bg-white hover:bg-gray-50'}`;
                listItem.setAttribute('data-recipe-id', recipe.id);
                listItem.onclick = () => saveMealAssignment(recipe.id);
                
                listItem.innerHTML = `
                    <span>${recipe.name}</span>
                    <span class="text-sm text-gray-500">${recipe.time || 'N/A'}</span>
                `;
                listContainer.appendChild(listItem);
            });
        }

        async function saveMealAssignment(newRecipeId) {
            const { day, meal } = currentSelectedSlot;
            
            if (!day || !meal || !db || !userId) return;

            try {
                const planDocPath = `artifacts/${appId}/users/${userId}/meal_plans/${currentWeekId}`;
                const planRef = doc(db, planDocPath);
                
                const fieldPath = `${day}.${meal}.recipeId`;
                const assignment = newRecipeId; 
                
                await setDoc(planRef, { [fieldPath]: assignment }, { merge: true });

                closeModal('select-recipe-modal');
            } catch (error) {
                console.error("Error saving meal assignment:", error);
            }
        }

        async function removeMealAssignment() {
            const { day, meal } = currentSelectedSlot;
            
            if (!day || !meal || !db || !userId) return;

            try {
                const planDocPath = `artifacts/${appId}/users/${userId}/meal_plans/${currentWeekId}`;
                const planRef = doc(db, planDocPath);
                
                const fieldPathToDelete = `${day}.${meal}`;

                await updateDoc(planRef, {
                    [fieldPathToDelete]: deleteField()
                });

                closeModal('select-recipe-modal');
            } catch (error) {
                console.error("Error removing meal assignment:", error);
            }
        }


        // --- UI Control Functions ---

        function setupModals() {
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.style.display = 'none';
            });
            document.body.classList.remove('modal-active');
        }

        function openModal(modalId) {
            document.body.classList.add('modal-active');
            const modal = document.getElementById(modalId);
            if(modal) {
                modal.style.display = 'flex';
                if (modalId === 'select-recipe-modal') updateRecipeSelectorList();
                if (modalId === 'import-url-modal') document.getElementById('import-url-status-message').classList.add('hidden');

                const content = modal.querySelector('.modal-content');
                if(content) {
                    void content.offsetWidth;
                    content.style.opacity = '1';
                    content.style.transform = 'translateY(0)';
                }
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if(modal) {
                const content = modal.querySelector('.modal-content');
                if(content) {
                    content.style.opacity = '0';
                    content.style.transform = 'translateY(20px)';
                }
                
                setTimeout(() => {
                    modal.style.display = 'none';
                    const allOverlays = document.querySelectorAll('.modal-overlay');
                    const anyOtherActive = Array.from(allOverlays).some(overlay => overlay.style.display === 'flex');

                    if (!anyOtherActive) {
                        document.body.classList.remove('modal-active');
                    }
                }, 300);
            }
        }

        /**
         * Switches the active view and updates the bottom navigation icons/colors.
         */
        function showView(viewId, event) {
            if (event) event.preventDefault();

            const views = document.querySelectorAll('.view');
            const navTabs = document.querySelectorAll('.nav-tab-bottom');
            const header = document.getElementById('top-header');

            views.forEach(view => {
                view.style.display = view.id === `${viewId}-view` ? 'block' : 'none';
                view.classList.toggle('active-view', view.id === `${viewId}-view`);
            });

            navTabs.forEach(tab => {
                const tabViewId = tab.getAttribute('data-view');
                const isCurrent = viewId === tabViewId;
                
                const icon = tab.querySelector('i');
                const text = tab.querySelector('span');
                
                // Null checks added here in previous fix to prevent TypeError
                if (icon) {
                    if (isCurrent) {
                        icon.style.color = 'var(--primary-dark)';
                    } else {
                        icon.style.color = '#9ca3af'; /* gray-400 */
                    }
                }
                
                if (text) {
                    if (isCurrent) {
                        text.classList.add('text-primary-dark', 'font-bold');
                        text.classList.remove('text-gray-500', 'font-medium');
                    } else {
                        text.classList.remove('text-primary-dark', 'font-bold');
                        text.classList.add('text-gray-500', 'font-medium');
                    }
                }
            });
            
            // Adjust header background color based on view, matching the image (Recipes has the strong teal background)
            if (header) {
                header.style.backgroundColor = (viewId === 'recipes' || viewId === 'discover') ? '#14b8a6' : 'white';
                header.style.color = (viewId === 'recipes' || viewId === 'discover') ? 'white' : '#1f2937';
                header.classList.toggle('shadow-lg', viewId === 'recipes' || viewId === 'discover');
                header.classList.toggle('shadow-sm', viewId === 'plan' || viewId === 'shopping');
                header.classList.toggle('border-b', viewId === 'plan' || viewId === 'shopping');
            }
            
            currentView = viewId;
        }


        document.addEventListener('DOMContentLoaded', () => {
            // Initialize lucide icons for first draw
            lucide.createIcons(); 
            
            initializeFirebase();
            setupModals();
            
            // Initial view setup after icons are ready
            showView(currentView);
            
            // Event listener for the URL Import form
            document.getElementById('import-url-form').addEventListener('submit', importRecipeFromUrl);
        });

        // Expose functions to the global scope
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.openRecipeDetail = openRecipeDetail;
        window.showView = showView;
        window.handleSlotClick = handleSlotClick;
        window.saveMealAssignment = saveMealAssignment;
        window.removeMealAssignment = removeMealAssignment;
        window.handleOCRUpload = handleOCRUpload;
        window.generateShoppingList = generateShoppingList;
        // Recipe Detail View (kept for completeness)
        function openRecipeDetail(cardElement) {
            const recipe = JSON.parse(cardElement.getAttribute('data-recipe-json'));
            
            document.getElementById('detail-name').textContent = recipe.name || 'Recipe Details';
            document.getElementById('detail-description').textContent = recipe.description || 'No detailed description available.';
            document.querySelector('[data-detail="time"]').textContent = recipe.time || 'N/A';
            document.querySelector('[data-detail="difficulty"]').textContent = recipe.difficulty || 'N/A';
            
            const ingredientList = document.getElementById('detail-ingredients');
            ingredientList.innerHTML = Array.isArray(recipe.ingredients) && recipe.ingredients.length > 0
                ? recipe.ingredients.map(ing => `<li>${ing}</li>`).join('')
                : '<p class="text-gray-500 italic">No ingredient list available.</p>';

            const instructionList = document.getElementById('detail-instructions');
            instructionList.innerHTML = Array.isArray(recipe.instructions) && recipe.instructions.length > 0
                ? recipe.instructions.map((step, index) => `<li>${step.replace(/^\d+\.\s*/, '')}</li>`).join('')
                : '<p class="text-gray-500 italic">No instructions available.</p>';

            openModal('recipe-detail-modal');
        }

    </script>
</body>
</html>
